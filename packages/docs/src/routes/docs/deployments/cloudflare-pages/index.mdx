---
title: Cloudflare Pages Adapter and Middleware | Deployments
contributors:
  - adamdbradley
  - manucorporat
  - OzzieOrca
  - himorishige
  - reemardelarosa
  - mhevery
  - igorbabko
  - mrhoodz
  - dario-piotrowicz
  - matthewlal
  - seanperez-net
updated_at: '2023-10-03T18:53:23Z'
created_at: '2023-04-06T21:28:28Z'
---

import PackageManagerTabs from '~/components/package-manager-tabs/index.tsx';

# Cloudflare Pages Adapter

Qwik City Cloudflare Pages adapter allows you to connect Qwik City to [Cloudflare Pages](https://pages.cloudflare.com/).

## Installation

To integrate the `cloudflare-pages` adapter, use the `add` command:


<PackageManagerTabs>
<span q:slot="pnpm">
```shell
pnpm run qwik add cloudflare-pages
```
</span>
<span q:slot="npm">
```shell
npm run qwik add cloudflare-pages
```
</span>
<span q:slot="yarn">
```shell
yarn run qwik add cloudflare-pages
```
</span>
<span q:slot="bun">
```shell
bun run qwik add cloudflare-pages
```
</span>
</PackageManagerTabs>

The adapter will add a new `vite.config.ts` within the `adapters/` directory, and a new entry file will be created, such as:

```shell
└── adapters/
    └── cloudflare-pages/
        └── vite.config.ts
└── src/
    └── entry.cloudflare-pages.tsx
```

Additionally, within the `package.json`, the `build.server` and `deploy` scripts will be updated.

Take note of your nodejs version in your local environment by running the `node -v` command:
```shell
node -v
v20.11.1
```

When using 

<PackageManagerTabs>
<span q:slot="pnpm">
```shell
pnpm create qwik@latest
```
</span>
<span q:slot="npm">
```shell
npm create qwik@latest
```
</span>
<span q:slot="yarn">
```shell
yarn create qwik
```
</span>
<span q:slot="bun">
```shell
bun create qwik@latest
```
</span>
</PackageManagerTabs>

to setup your Qwik app it will likely use a different nodejs version than what Cloudflare Pages uses by default (v16.20.2).

## Production build

To build the application for production, use the `build` command, this command will automatically run `build.server` and `build.client`:

<PackageManagerTabs>
<span q:slot="pnpm">
```shell
pnpm run build
```
</span>
<span q:slot="npm">
```shell
npm run build
```
</span>
<span q:slot="yarn">
```shell
yarn run build
```
</span>
<span q:slot="bun">
```shell
bun run build
```
</span>
</PackageManagerTabs>

[Read the full guide here](https://github.com/QwikDev/qwik/tree/main/starters/adapters/cloudflare-pages/README.md)

## Deploy to Cloudflare Pages

After installing the integration the project is ready to be deployed to Cloudflare Pages.

If the nodejs version is different in your environment than Cloudflare Pages (v16.20.2) you'll need to add a `NODE_VERSION` environment variable and set the value to the version that you got from running the `node -v` command in your environment:

```shell
node -v
v20.11.1
```

To do this in Cloudflare go to **Workers & Pages > YOUR_PROJECT > Settings > Environment variables > Production (and Preview) > Add variables > Save **

Please refer to the [Cloudflare Pages docs](https://developers.cloudflare.com/pages/framework-guides/deploy-a-qwik-site/) for more information on how to deploy your site.

Note that you will need a [Cloudflare account](https://dash.cloudflare.com/sign-up?lang=en-US) in order to complete this step.

## Configuring Wrangler for Cloudflare Pages

Upon completion of the following section, the updated file structure should be as such:

```shell
└── adapters/
    └── cloudflare-pages/
        └── vite.config.ts
└── src/
    └── entry.cloudflare-pages.tsx
└── worker-configuration.d.ts
└── wrangler.toml
```

### Cloudflare Pages Wrangler

When the cloudflare-pages adapter is added, wrangler is added to the package.json file and installed. To configure wrangler and add your project's Cloudflare environment and wrangler.toml file to your project's src/, an active Cloudflare account and project will be required.

Please refer to the Cloudflare Pages docs for more information on how to configure your project via wrangler.toml.

Below is an example of using the Wrangler CLI to configure/update your project with Wrangler.

Login using Wrangler CLI. In VSCode, this will open your browser to Cloudflare's website and ask you to accept the CLI to log in to your account if you are already logged in. If not, proceed through the website's login process.
<PackageManagerTabs>
<span q:slot="pnpm">
```shell
pnpm wrangler login
```
</span>
<span q:slot="npm">
```shell
npx wrangler login
```
</span>
<span q:slot="yarn">
```shell
yarn wrangler login
```
</span>
<span q:slot="bun">
```shell
bunx wrangler login
```
</span>
</PackageManagerTabs>

Using the Wrangler CLI to download the config for your project. You must have an existing project for this to work. If not, refer to the Cloudflare documentation provided above to create a new project.
To do this in Cloudflare, go to **Workers & Pages > Create **
<PackageManagerTabs>
<span q:slot="pnpm">
```shell
pnpm wrangler pages download config <PROJECT_NAME>
```
</span>
<span q:slot="npm">
```shell
npx wrangler pages download config <PROJECT_NAME>
```
</span>
<span q:slot="yarn">
```shell
yarn wrangler pages download config <PROJECT_NAME>
```
</span>
<span q:slot="bun">
```shell
bunx wrangler pages download config <PROJECT_NAME>
```
</span>
</PackageManagerTabs>

You should now see a new file called wrangler.toml in your project's root directory. Now you can proceed to import your Cloudflare types/bindings using the Wrangler CLI.
<PackageManagerTabs>
<span q:slot="pnpm">
```shell
pnpm wrangler types
```
</span>
<span q:slot="npm">
```shell
npx wrangler types
```
</span>
<span q:slot="yarn">
```shell
yarn wrangler types
```
</span>
<span q:slot="bun">
```shell
bunx wrangler types
```
</span>
</PackageManagerTabs>

You should now see another new file in your project's root directory called worker-configuration.d.ts. This file should contain an interface Env {<YOUR TYPES | BINDINGS> } which should be globally available throughout your project. If you currently have another globally available Env type/interface, this may need to be adjusted accordingly. You can proceed to the Advanced step below to include this in the src/entry.cloudflare-pages.tsx file.

## Advanced

### Cloudflare Pages Entry Middleware

When the `cloudflare-pages` adapter is added, a new entry file will be created at `src/entry.cloudflare-pages.tsx`. Below is an example of using the built-in middleware within the entry file.

```tsx title="src/entry.cloudflare-pages.tsx"
import {
  createQwikCity,
  type PlatformCloudflarePages,
} from '@builder.io/qwik-city/middleware/cloudflare-pages';
import qwikCityPlan from '@qwik-city-plan';
import { manifest } from '@qwik-client-manifest';
import render from './entry.ssr';

const fetch = createQwikCity({ render, qwikCityPlan, manifest });

export { fetch };
```

> If you are following the previous section [Configuring Wrangler for Cloudflare Pages](#configuring-wrangler-for-cloudflare-pages),
> you may want to add your `interface Env{}` here.

```tsx title="src/entry.cloudflare-pages.tsx"
declare global {
  interface QwikCityPlatform extends PlatformCloudflarePages {
    env: Env; // add the following here , there should be no import necessary 
  }
}
```

The compiled middleware will be built in the `server/` directory. Such directory also contains a `_worker.js` file which implements the application's request handling as per the [Cloudflare Pages Advanced Mode](https://developers.cloudflare.com/pages/platform/functions/advanced-mode/#advanced-mode).
The file simply re-exports the produced `fetch` handler as shown below.

```tsx title="/dist/_worker.js"
import { fetch } from "../server/entry.cloudflare-pages";
export default { fetch };
```

- [Cloudflare Pages Middleware Source](https://github.com/QwikDev/qwik/tree/main/packages/qwik-city/middleware/cloudflare-pages/index.ts)
- [Cloudflare Pages Advanced Mode](https://developers.cloudflare.com/pages/platform/functions/advanced-mode/)
- [Function Invocation Route Config](https://developers.cloudflare.com/pages/platform/functions/routing/#functions-invocation-routes)

### Cloudflare Pages Function Invocation Routes

Cloudflare Page's [function-invocation-routes config](https://developers.cloudflare.com/pages/platform/functions/routing/#functions-invocation-routes) can be used to include, or exclude, certain paths to be used by the worker functions. Having a `_routes.json` file gives developers more granular control over when your Function is invoked.

This is useful to determine if a page response should be Server-Side Rendered (SSR) or if the response should use a static-site generated (SSG) `index.html` file instead.

By default, the Cloudflare Pages adapter _does not_ include a `public/_routes.json` config, but rather it is auto-generated from the build by the Cloudflare adapter. An example of an auto-generated `dist/_routes.json` would be:

```json
{
  "include": ["/*"],
  "exclude": [
    "/_headers",
    "/_redirects",
    "/build/*",
    "/favicon.ico",
    "/manifest.json",
    "/service-worker.js",
    "/about"
  ],
  "version": 1
}
```

In the above example, it's saying _all_ pages should be SSR'd. However, the root static files such as `/favicon.ico` and any static assets in `/build/*` should be excluded from the Functions, and instead treated as a static file.

In most cases the generated `dist/_routes.json` file is ideal. However, if you need more granular control over each path, you can instead provide your own `public/_routes.json` file. When the project provides its own `public/_routes.json` file, then the Cloudflare adapter will not auto-generate the routes config and instead use the committed one within the `public` directory.

### Context

You may access Cloudflare Page's environment variables in the endpoint method's `platform` param:

```ts
export const onRequest = async ({ platform }) => {
  const secret = platform.env['SUPER_SECRET_TOKEN'];
};
```

Additionally, you may import the `RequestHandler` and `PlatformCloudflarePages` types to have type completions in your editor.

```tsx
import { type RequestHandler } from '@builder.io/qwik-city';
import { type PlatformCloudflarePages } from '@builder.io/qwik-city/middleware/cloudflare-pages';

export const onGet: RequestHandler<PlatformCloudflarePages> = ({ platform }) => {
  //...
};
```
